{% extends "base.html" %}
{% block content %}
<h1>{{ game['title'] }}</h1>
{% if error %}<div class="error">{{ error }}</div>{% endif %}
{% if success %}<div class="notice notice-strong">{{ success }}</div>{% endif %}
{% if game['is_cancelled'] %}
<div class="error">This game is cancelled. Invitees will see this game as cancelled.</div>
{% endif %}
<p class="game-meta">
  <span class="game-datetime">üóìÔ∏è {{ game['game_date'] }} at {{ game['game_time'] }}</span>
  <span class="game-location">
    üìç {{ game['location'] }}
  </span>
</p>
<div class="row">
  <button class="btn secondary copy-btn" type="button" data-link="https://{{ request.headers.get('host') }}/game?g={{ game['code'] }}">Copy Invite Link</button>
  <button class="btn secondary copy-text-btn" type="button">Copy Invite Text</button>
  <span class="badge">Invite Link: /game?g={{ game['code'] }}</span>
  <span class="badge">Players IN: {{ in_count }} / {{ game['total_players'] }}</span>
  {% if game['is_cancelled'] %}<span class="badge">Status: Cancelled</span>{% endif %}
</div>
<div class="row" style="margin-top: 12px;">
  {% if not game['is_cancelled'] %}
  <form method="post" action="/games/{{ game['id'] }}/cancel" onsubmit="return confirm('Cancel this game? Invitees will see it as cancelled.');">
    <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
    <button class="btn danger" type="submit">Cancel Game</button>
  </form>
  {% endif %}
  <form method="post" action="/games/{{ game['id'] }}/delete" onsubmit="return confirm('Delete this game and all RSVPs?');">
    <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
    <button class="btn danger" type="submit">Delete Game</button>
  </form>
</div>

<h2>RSVPs</h2>
<div class="rotate-pill" aria-hidden="true">Rotate to landscape to edit RSVPs</div>
<div class="row" style="margin-bottom: 12px;">
  <span class="badge" id="activeFilter" style="display:none;">Filter: <span id="activeFilterValue"></span> (tap to clear)</span>
</div>
<table class="table rsvp-table" id="rsvpTable">
  <thead>
    <tr>
      <th id="sortName" style="cursor: pointer;">Name</th>
      <th class="hide-mobile">Cell</th>
      <th id="sortSeat" style="cursor: pointer;">Seat</th>
      <th id="sortStatus" style="cursor: pointer;">Status</th>
      <th>ETA</th>
      <th class="hide-mobile" id="sortTime" style="cursor: pointer;">Time</th>
      <th class="hide-mobile">Edit</th>
      <th>Text</th>
    </tr>
  </thead>
  <tbody>
  {% for r in rsvps %}
    <tr data-status="{{ r['status'] }}">
      <td data-label="Name">{{ r['name'] }}</td>
      <td class="hide-mobile" data-label="Cell">{{ r['phone'] | fmt_phone }}</td>
      <td data-label="Seat" data-seat-number="{{ r['seat_number'] or '' }}">{{ r['seat_label'] or '-' }}</td>
      <td data-label="Status">{{ r['status'] }}</td>
      <td data-label="ETA">{{ r['late_eta'] or '-' }}</td>
      <td class="hide-mobile" data-label="Time">{{ r['created_at'] | fmt_ts }}</td>
      <td class="hide-mobile" data-label="Edit">
        <button class="btn secondary edit-rsvp-btn edit-btn" type="button"
          data-id="{{ r['id'] }}"
          data-name="{{ r['name'] }}"
          data-status="{{ r['status'] }}"
          data-eta="{{ r['late_eta'] or '' }}"
          data-phone="{{ r['phone'] or '' }}">
          Edit
        </button>
      </td>
      <td data-label="Text">
        {% if r['phone'] %}
          <button class="btn secondary text-btn" type="button" data-phone="{{ r['phone'] }}" data-seat-label="{{ r['seat_label'] or '' }}">Text</button>
        {% else %}
          <span class="badge">‚Äî</span>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<form method="post" action="/games/{{ game['id'] }}/rsvp/add" class="row" style="margin-top: 12px; gap: 8px; align-items: center;">
  <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
  <input type="text" name="name" placeholder="Name" required>
  <input type="tel" name="phone" placeholder="+1 (807) 555-1234">
  <select name="status" required>
    <option value="IN">IN</option>
    <option value="LATE">LATE</option>
    <option value="OUT">OUT</option>
  </select>
  <button class="btn" type="submit">Add Player</button>
</form>

<h2>Standby List</h2>
{% if standby|length == 0 %}
  <p>No one on standby yet.</p>
{% else %}
<table class="table rsvp-table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Cell</th>
      <th>#</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
  {% for s in standby %}
    <tr>
      <td data-label="Name">{{ s['name'] }}</td>
      <td data-label="Cell">{{ s['phone'] | fmt_phone }}</td>
      <td data-label="#">#{{ loop.index }}</td>
      <td data-label="Action">
        <form method="post" action="/games/{{ game['id'] }}/standby/{{ s['id'] }}/promote">
          <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
          <button class="btn" type="submit">Add IN</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}

<div id="rsvpModal" class="modal" style="display:none;">
  <div class="modal-card">
    <h3>Edit RSVP</h3>
    <form method="post" id="rsvpEditForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
      <div>
        <label>Name</label>
        <input type="text" name="name" id="editName" required>
      </div>
      <div>
        <label>Status</label>
        <select name="status" id="editStatus">
          <option value="IN">IN</option>
          <option value="LATE">LATE</option>
          <option value="OUT">OUT</option>
          <option value="HOST">HOST</option>
        </select>
      </div>
      <div>
        <label>Cell</label>
        <input type="tel" name="phone" id="editPhone" placeholder="+1 (807) 555-1234">
      </div>
      <div>
        <label>ETA</label>
        <input type="text" name="late_eta" id="editEta" placeholder="ETA">
      </div>
      <div class="row">
        <button class="btn" type="submit">Save</button>
        <button class="btn secondary" type="button" id="closeModal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  setTimeout(() => { window.location.reload(); }, 30000);

  (function() {
    const activeFilter = document.getElementById('activeFilter');
    const activeFilterValue = document.getElementById('activeFilterValue');
    const sortStatusBtn = document.getElementById('sortStatus');
    const sortNameBtn = document.getElementById('sortName');
    const sortTimeBtn = document.getElementById('sortTime');
    const sortSeatBtn = document.getElementById('sortSeat');
    const tbody = document.querySelector('#rsvpTable tbody');
    if (!tbody || !activeFilter || !activeFilterValue) return;

    const order = { IN: 0, HOST: 1, LATE: 2, OUT: 3 };

    let currentFilter = null;
    function applyFilter() {
      const value = currentFilter;
      tbody.querySelectorAll('tr').forEach(tr => {
        const status = (tr.getAttribute('data-status') || '').trim().toUpperCase();
        const show = !value
          || status === value
          || (value === 'IN' && status === 'HOST');
        tr.style.display = show ? '' : 'none';
      });
      if (value) {
        activeFilterValue.textContent = value;
        activeFilter.style.display = 'inline-flex';
      } else {
        activeFilter.style.display = 'none';
      }
    }

    function sortByStatus() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        const sa = order[(a.getAttribute('data-status') || '').trim().toUpperCase()] ?? 99;
        const sb = order[(b.getAttribute('data-status') || '').trim().toUpperCase()] ?? 99;
        return sa - sb;
      });
      rows.forEach(r => tbody.appendChild(r));
    }

    function sortByName() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        const an = (a.querySelector('[data-label="Name"]')?.textContent || '').trim().toLowerCase();
        const bn = (b.querySelector('[data-label="Name"]')?.textContent || '').trim().toLowerCase();
        return an.localeCompare(bn);
      });
      rows.forEach(r => tbody.appendChild(r));
    }

    function sortByTime() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        const at = (a.querySelector('[data-label="Time"]')?.textContent || '').trim();
        const bt = (b.querySelector('[data-label="Time"]')?.textContent || '').trim();
        const ad = at ? new Date(at.replace(' ', 'T') + ':00') : new Date(0);
        const bd = bt ? new Date(bt.replace(' ', 'T') + ':00') : new Date(0);
        return ad - bd;
      });
      rows.forEach(r => tbody.appendChild(r));
    }

    function sortBySeat() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        const at = a.querySelector('[data-label="Seat"]');
        const bt = b.querySelector('[data-label="Seat"]');
        const an = parseInt(at?.getAttribute('data-seat-number') || '', 10);
        const bn = parseInt(bt?.getAttribute('data-seat-number') || '', 10);
        const av = Number.isNaN(an) ? 1e9 : an;
        const bv = Number.isNaN(bn) ? 1e9 : bn;
        return av - bv;
      });
      rows.forEach(r => tbody.appendChild(r));
    }

    sortStatusBtn && sortStatusBtn.addEventListener('click', () => {
      sortByStatus();
      applyFilter();
    });

    sortNameBtn && sortNameBtn.addEventListener('click', () => {
      sortByName();
      applyFilter();
    });

    sortTimeBtn && sortTimeBtn.addEventListener('click', () => {
      sortByTime();
      applyFilter();
    });

    sortSeatBtn && sortSeatBtn.addEventListener('click', () => {
      sortBySeat();
      applyFilter();
    });

    activeFilter.addEventListener('click', () => {
      currentFilter = null;
      applyFilter();
    });

    tbody.addEventListener('click', (e) => {
      const row = e.target.closest('tr');
      if (!row) return;
      const status = row.getAttribute('data-status');
      if (!status) return;
      currentFilter = (currentFilter === status) ? null : status;
      applyFilter();
    });

    // Default organizer view: keep IN at the top.
    sortByStatus();
    applyFilter();
  })();

  (function() {
    const btn = document.querySelector('.copy-btn');
    if (!btn) return;
    btn.addEventListener('click', async () => {
      const link = btn.getAttribute('data-link');
      try {
        await navigator.clipboard.writeText(link);
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy Invite Link'; }, 1500);
      } catch (e) {
        prompt('Copy this link:', link);
      }
    });
  })();

  function inviteText(seatLabel) {
    const link = "https://{{ request.headers.get('host') }}/game?g={{ game['code'] }}";
    const seatLine = seatLabel ? `\nSeat: ${seatLabel}` : '';
    const title = {{ game['title'] | tojson }};
    const location = {{ game['location'] | tojson }};
    return `Poker game: ${title}\nWhen: {{ game['game_date'] }} at {{ game['game_time'] }}\nWhere: ${location}` + seatLine + `\nUPDATE/RSVP: ` + link;
  }

  (function() {
    const btn = document.querySelector('.copy-text-btn');
    if (!btn) return;
    btn.addEventListener('click', async () => {
      const text = inviteText('');
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy Invite Text'; }, 1500);
      } catch (e) {
        prompt('Copy this text:', text);
      }
    });
  })();

  (function() {
    document.querySelectorAll('.text-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const raw = btn.getAttribute('data-phone') || '';
        let phone = raw.replace(/[^0-9]/g, '');
        if (!phone) return;
        if (phone.length === 10) {
          phone = `+1${phone}`;
        } else if (phone.length === 11 && phone.startsWith('1')) {
          phone = `+${phone}`;
        }
        const seatLabel = btn.getAttribute('data-seat-label') || '';
        const body = encodeURIComponent(inviteText(seatLabel));
        window.location.href = `sms:${phone}?body=${body}`;
      });
    });
  })();

  (function() {
    const modal = document.getElementById('rsvpModal');
    const form = document.getElementById('rsvpEditForm');
    const nameInput = document.getElementById('editName');
    const statusInput = document.getElementById('editStatus');
    const etaInput = document.getElementById('editEta');
    const phoneInput = document.getElementById('editPhone');
    const closeBtn = document.getElementById('closeModal');
    document.querySelectorAll('.edit-rsvp-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        nameInput.value = btn.getAttribute('data-name') || '';
        statusInput.value = btn.getAttribute('data-status') || 'IN';
        etaInput.value = btn.getAttribute('data-eta') || '';
        phoneInput.value = btn.getAttribute('data-phone') || '';
        form.action = `/games/{{ game['id'] }}/rsvp/${id}/update`;
        modal.style.display = 'flex';
      });
    });
    closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });
  })();
</script>
{% endblock %}
