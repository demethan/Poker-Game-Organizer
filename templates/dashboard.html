{% extends "base.html" %}
{% block content %}
<h1>Welcome, {{ user['name'] }}</h1>
<div class="row">
  <a class="btn" href="/games/new">Create New Game</a>
</div>

<h2>Your Games</h2>
{% if games|length == 0 %}
  <p>No games yet.</p>
{% else %}
  {% for game in games %}
  <div class="card">
    <h3>{{ game['title'] }}</h3>
    <p>{{ game['game_date'] }} at {{ game['game_time'] | fmt_game_time }} â€¢ {{ game['location'] }}</p>
    <div class="row">
      <span class="badge">Total Players: {{ game['total_players'] }}</span>
      <span class="badge">Code: {{ game['code'] }}</span>
      {% if game['is_cancelled'] %}<span class="badge">Cancelled</span>{% endif %}
    </div>
    <div class="row" style="margin-top: 12px;">
      <a class="btn secondary" href="/games/{{ game['id'] }}">View</a>
      <button
        class="btn secondary copy-btn"
        type="button"
        data-link="https://{{ request.headers.get('host') }}/game?g={{ game['code'] }}"
        data-title="{{ game['title'] }}"
        data-date="{{ game['game_date'] }}"
        data-time="{{ game['game_time'] | fmt_game_time }}"
        data-location="{{ game['location'] }}"
      >Copy Invite Link</button>
      <button class="btn secondary copy-host-btn" type="button" data-link="https://{{ request.headers.get('host') }}/h/{{ game['host_code'] }}">Copy Host Link</button>
      <span class="badge">Invite Link: /game?g={{ game['code'] }}</span>
      <span class="badge">Host Link: /h/{{ game['host_code'] }}</span>
      <form method="post" action="/games/{{ game['id'] }}/delete" onsubmit="return confirm('Delete this game and all RSVPs?');" style="margin-left:auto;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
        <button class="btn danger" type="submit">Delete Game</button>
      </form>
    </div>
  </div>
  {% endfor %}
{% endif %}

<script>
  (function() {
    const buttons = document.querySelectorAll('.copy-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const link = btn.getAttribute('data-link');
        try {
          await navigator.clipboard.writeText(link);
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = 'Copy Invite Link'; }, 1500);
        } catch (e) {
          prompt('Copy this link:', link);
        }
      });
    });

    const hostButtons = document.querySelectorAll('.copy-host-btn');
    hostButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const link = btn.getAttribute('data-link');
        try {
          await navigator.clipboard.writeText(link);
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = 'Copy Host Link'; }, 1500);
        } catch (e) {
          prompt('Copy this host link:', link);
        }
      });
    });
  })();
</script>
{% endblock %}
